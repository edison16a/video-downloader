<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Automatic HLS Downloader</title>
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: Arial;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .box {
      background: #020617;
      padding: 20px;
      border-radius: 10px;
      width: 450px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
    }
    .bar {
      margin-top: 15px;
      background: #1e293b;
      border-radius: 8px;
      overflow: hidden;
      height: 20px;
    }
    .fill {
      background: #22c55e;
      height: 100%;
      width: 0%;
      transition: width 0.2s;
    }
  </style>
</head>
<body>
  <div class="box">
    <h2>Automatic HLS Downloader</h2>

    <input id="url" placeholder="Paste video page URL here">
    <button onclick="download()">Download</button>
    <small style="color:#94a3b8;display:block;margin-top:6px;">When prompted, pick where to save the final video.</small>

    <div class="bar">
      <div class="fill" id="fill"></div>
    </div>

    <p id="status"></p>
  </div>

  <script>
    const progressSource = new EventSource("/progress");

    progressSource.onmessage = event => {
      const percent = parseFloat(event.data);
      if (!isNaN(percent)) {
        document.getElementById("fill").style.width = percent + "%";
        document.getElementById("status").textContent = `Downloading… ${percent}%`;
      }
    };

    async function download() {
      document.getElementById("fill").style.width = "0%";
      document.getElementById("status").textContent = "Detecting stream…";

      const statusEl = document.getElementById("status");
      statusEl.textContent = "Choose where to save…";

      // Ask the user where they want to save the file (Chromium browsers only).
      let fileHandle = null;
      if (window.showSaveFilePicker) {
        try {
          fileHandle = await window.showSaveFilePicker({
            suggestedName: "video.mp4",
            types: [{ description: "MP4 Video", accept: { "video/mp4": [".mp4"] } }]
          });
        } catch (err) {
          if (err.name === "AbortError") {
            statusEl.textContent = "Save cancelled.";
            return;
          }
        }
      }

      statusEl.textContent = "Detecting stream…";

      const res = await fetch("/download", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          url: document.getElementById("url").value
        })
      });

      if (!res.ok) {
        statusEl.textContent = "Failed.";
        return;
      }

      const disposition = res.headers.get("Content-Disposition");
      const parsedName = (() => {
        if (!disposition) return null;
        const utfMatch = disposition.match(/filename\*=UTF-8''([^;]+)/i);
        if (utfMatch && utfMatch[1]) return decodeURIComponent(utfMatch[1]);
        const match = disposition.match(/filename=\"?([^\";]+)\"?/i);
        return match ? match[1] : null;
      })();
      const fileName = parsedName || "video.mp4";

      let savedWithPicker = false;

      if (fileHandle) {
        const streamResponse = res.clone();
        try {
          const writable = await fileHandle.createWritable();
          if (streamResponse.body) {
            await streamResponse.body.pipeTo(writable);
          } else {
            await writable.write(await streamResponse.blob());
            await writable.close();
          }
          savedWithPicker = true;
          statusEl.textContent = "Saved to your chosen folder.";
        } catch (err) {
          console.error("Saving via picker failed", err);
          statusEl.textContent = "Save failed, falling back to browser download…";
        }
      }

      if (!savedWithPicker) {
        const blob = await res.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
        statusEl.textContent = "Done.";
      }
    }
  </script>
</body>
</html>
